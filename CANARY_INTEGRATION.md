# 金丝雀测试 - 集成指南

## 概述

iOS Coding Skills 插件内置了金丝雀测试功能，用于检测 AI 上下文丢失。安装插件后会自动为项目创建 `.canary.md` 金丝雀文件。

## 自动启用

插件安装后，金丝雀测试会自动启用：

1. **插件安装时**：自动运行 `scripts/init-canary.sh` 脚本
2. **金丝雀文件创建**：在项目根目录创建 `.canary.md` 文件
3. **唯一 ID 生成**：为每个项目生成唯一的金丝雀 ID
4. **项目约定记录**：将 iOS 编码规范记录到金丝雀文件中

## 金丝雀文件结构

```markdown
# iOS 项目金丝雀测试标记

<!-- CANARY_TEST_START -->
金丝雀 ID: canary_1770604023_n0s4e6
创建时间: 2026-02-09T02:27:03Z
项目类型: iOS 项目
<!-- CANARY_TEST_END -->

## 说明
...

## 金丝雀 ID
当前项目的金丝雀 ID：`canary_1770604023_n0s4e6`

## 项目约定（iOS Coding Skills）
本项目遵循以下 iOS 编码规范：
...
```

## 使用方法

### 检查金丝雀状态

```bash
# 查看金丝雀文件
cat .canary.md

# 在 Claude Code 中询问
"请读取 .canary.md 文件，告诉我金丝雀 ID 是什么"
```

### AI 记住金丝雀 ID

在长时间的开发会话中，AI 会记住金丝雀 ID，这表明它仍然记得项目的上下文和约定。

### 上下文丢失的信号

如果 AI 无法回忆起金丝雀 ID，说明上下文可能已丢失：

```
用户: 请告诉我 .canary.md 文件中的金丝雀 ID
AI: 抱歉，我无法访问该文件...
```

这表示需要重新加载项目约定。

### 恢复项目约定

当上下文丢失时：

1. **使用 skill 命令**：
   ```
   请使用 /coding-standards 重新加载编码规范
   ```

2. **让 AI 读取金丝雀文件**：
   ```
   请读取项目根目录的 .canary.md 文件
   ```

3. **开始新的对话会话**：清理上下文，重新开始

## 与 My Claude HUD 集成

如果你同时使用了 [My Claude HUD](https://github.com/Link-Start/my-claude-hud) 插件：

- ✅ HUD 会自动显示金丝雀状态
- ✅ 实时监控 AI 是否还记得金丝雀
- ✅ 在上下文丢失时及时提醒

HUD 显示效果：
```
Canary: 🐤 活跃 (n0s4e6...) <1m
```

## 配置选项

### 禁用金丝雀测试

```bash
# 删除金丝雀文件
rm .canary.md
```

### 重新启用金丝雀测试

```bash
# 运行初始化脚本
cd ~/Desktop/ios-coding-skills
./scripts/init-canary.sh /你的项目路径
```

### 自定义金丝雀文件

你可以手动编辑 `.canary.md` 文件，添加项目特定的约定：

```markdown
## 项目特定约定

- 使用 MVC + MVVM 架构
- 网络请求统一使用 AFNetworking 3.0
- 图片加载使用 SDWebImage
- ...
```

## 技术原理

### 工作流程

1. **安装阶段**
   ```
   安装插件 → 运行 init-canary.sh → 创建 .canary.md
   ```

2. **使用阶段**
   ```
   AI 读取 .canary.md → 记住金丝雀 ID → 保持项目约定
   ```

3. **监控阶段**
   ```
   定期检查 → AI 回忆金丝雀 ID → 判断上下文状态
   ```

4. **恢复阶段**
   ```
   检测到丢失 → 使用 /coding-standards → 重新加载约定
   ```

### 金丝雀 ID 格式

```
canary_{时间戳}_{随机字符}
```

示例：`canary_1770604023_n0s4e6`

### 标记块格式

金丝雀文件使用 HTML 注释标记关键信息：

```html
<!-- CANARY_TEST_START -->
金丝雀 ID: ...
创建时间: ...
项目类型: ...
<!-- CANARY_TEST_END -->
```

这个格式便于解析和提取关键信息。

## 常见问题

### Q: 金丝雀文件会被编译到应用中吗？

A: 不会。`.canary.md` 只是一个项目文档文件，不会被 Xcode 编译。

### Q: 需要将金丝雀文件提交到 Git 吗？

A: 推荐。这样团队成员都能了解项目约定，也能共享金丝雀测试功能。

在 `.gitignore` 中通常不需要忽略 `.canary.md`。

### Q: 每个项目都有不同的金丝雀 ID 吗？

A: 是的。每次初始化都会生成唯一的金丝雀 ID，确保每个项目都有独立的标识。

### Q: 金丝雀测试会影响性能吗？

A: 不会。金丝雀测试只在需要时检查文件，对性能没有影响。

### Q: 如何在多个项目中使用？

A: 每个项目安装插件时会自动创建独立的金丝雀文件，无需额外配置。

### Q: 与 My Claude HUD 的关系？

A: 金丝雀测试是独立功能，可以单独使用。My Claude HUD 提供可视化的状态监控。

## 最佳实践

1. **团队协作**：将金丝雀文件提交到版本控制
2. **定期检查**：在长时间会话中定期检查金丝雀状态
3. **及时恢复**：检测到上下文丢失时立即重新加载约定
4. **自定义约定**：根据项目需求修改金丝雀文件内容

## 示例对话

### 场景 1：正常使用

```
用户: 请创建一个 UIButton
AI: [遵循编码规范创建 UIButton]
用户: .canary.md 中的金丝雀 ID 是什么？
AI: 金丝雀 ID 是 canary_1770604023_n0s4e6
```

### 场景 2：上下文丢失

```
用户: .canary.md 中的金丝雀 ID 是什么？
AI: 抱歉，我无法访问该文件...
用户: 请使用 /coding-standards 重新加载
AI: [重新加载编码规范]
用户: 现在金丝雀 ID 是什么？
AI: 金丝雀 ID 是 canary_1770604023_n0s4e6
```

## 总结

金丝雀测试是一个简单但强大的工具，帮助你：

- ✅ 监控 AI 上下文状态
- ✅ 及时发现上下文丢失
- ✅ 快速恢复项目约定
- ✅ 提高开发效率

安装 iOS Coding Skills 插件后，金丝雀测试会自动启用，无需额外配置。
